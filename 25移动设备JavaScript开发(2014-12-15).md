# 移动设备JavaScript开发(2014/12/15)

标签（空格分隔）： 前端 js

---

> 今天是这一章的第三部分，网络连接故障与离线状态。238页~247页。

## **网络连接故障与离线状态**
> 在移动设备上浏览网页会遇到一个常见的问题，那就是网络连接掉线问题。我们的网页应用需要在屏幕上告知网络连接已经断开，或把HTTP请求缓存起来，直至网络连接恢复时在发出。

### **在线与离线状态的检测**
- 利用浏览器的**navigator.onLine**属性，检测当前的网络连接是否已经断开：
```
var isOnline = navigator.onLine;

if(isOnline){
    //网络可访问情况下运行的代码
} else {
    //不可访问...
}
```

> 与其不断地检测**navigator.onLine**的值，我们不如利用两个事件，它们各自在网络连接断开和网络连接回复时发生，名称分别为**offline**和**online**.

- 下面演示功能：当网络连接断开，把Ajax调用起来，而当连接回复时，马上发出这些Ajax调用。
```
var stack = [];

function ajax(url, callback){
	
	var xhr = new XMLHttpRequest(),
		LOADED_STATE = 4,
		OK_STATUS = 200;

	if(!navigator.onLine){
		stack.push(arguments);
	}else{
		xhr.onreadystatechange = function(){
			if(xhr.readyState !== LOADED_STATE){
				return;
			}

			if(xhr.status === OK_STATUS){
				callback(xhr.responseText);
			}
		};

		xhr.open('GET', url);
		xhr.send();
	}
}

function clearStack(){

	while(stack.length){
		ajax.apply(ajax, stack.shift());
	}

}

window.addEventListener('online', clearStack, false);
```

### **利用Web Storage API长期保存数据**
> 当网络连接断开时，如果用户关闭了此标签页，那么我们的内存数据就会被抹除。如上面的代码。

> 我们现在可以使用HTML5 Web Storage API。（[文档][1]）。该规范中定义了两个对象**window.sessionStorage**和**window.localStorage**。

- **sessionStorage**:数据的保存时间只能是用户浏览器使用期间。
- **localStorage**:可以是数据的保存时间跨越浏览器的生命周期，直至用户手动删除，或由你的程序控制删除。


### **HTML5 Application Cache**
### **响应式网页设计的JavaScript**


  [1]: http://www.w3.org/TR/webstorage